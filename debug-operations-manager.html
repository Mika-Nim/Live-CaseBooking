<!DOCTYPE html>
<html>
<head>
    <title>Debug Operations Manager Access</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .fix-button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .fix-button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç Operations Manager Access Debugger</h1>
    
    <div class="section">
        <h2>Current Session Data</h2>
        <div id="session-data"></div>
    </div>
    
    <div class="section">
        <h2>All Users Data</h2>
        <div id="users-data"></div>
    </div>
    
    <div class="section">
        <h2>Cases Data</h2>
        <div id="cases-data"></div>
    </div>
    
    <div class="section">
        <h2>Operations Manager Analysis</h2>
        <div id="analysis"></div>
    </div>
    
    <div class="section">
        <h2>Quick Fixes</h2>
        <button class="fix-button" onclick="fixOperationsManagerUser()">Create Test Operations Manager</button>
        <button class="fix-button" onclick="createTestCases()">Create Test Cases for Singapore</button>
        <button class="fix-button" onclick="clearLocalStorage()">Clear All Data (Reset)</button>
    </div>

    <script>
        function loadAndDisplay() {
            // Get session data
            const session = JSON.parse(localStorage.getItem('case-booking-session') || 'null');
            document.getElementById('session-data').innerHTML = session 
                ? `<pre>${JSON.stringify(session, null, 2)}</pre>`
                : '<span class="error">No active session</span>';
            
            // Get users data
            const users = JSON.parse(localStorage.getItem('case-booking-users') || '[]');
            document.getElementById('users-data').innerHTML = users.length > 0
                ? `<pre>${JSON.stringify(users, null, 2)}</pre>`
                : '<span class="error">No users found</span>';
            
            // Get cases data
            const cases = JSON.parse(localStorage.getItem('case-booking-cases') || '[]');
            document.getElementById('cases-data').innerHTML = cases.length > 0
                ? `<pre>Total Cases: ${cases.length}\n${JSON.stringify(cases.slice(0, 3), null, 2)}${cases.length > 3 ? '\n... and ' + (cases.length - 3) + ' more' : ''}</pre>`
                : '<span class="error">No cases found</span>';
            
            // Analysis
            let analysis = '';
            
            if (session) {
                analysis += `<h3>Current User Analysis:</h3>`;
                analysis += `<p><strong>Role:</strong> ${session.role}</p>`;
                analysis += `<p><strong>Username:</strong> ${session.username}</p>`;
                analysis += `<p><strong>Selected Country:</strong> ${session.selectedCountry || 'None'}</p>`;
                analysis += `<p><strong>Assigned Departments:</strong> ${session.departments ? session.departments.join(', ') : 'None'}</p>`;
                analysis += `<p><strong>Assigned Countries:</strong> ${session.countries ? session.countries.join(', ') : 'None'}</p>`;
                
                if (session.role === 'operations-manager' || session.role === 'operation-manager') {
                    analysis += `<h3 class="success">‚úÖ User has Operations Manager role</h3>`;
                    
                    if (!session.selectedCountry) {
                        analysis += `<p class="error">‚ùå Issue: No selected country</p>`;
                    } else {
                        analysis += `<p class="success">‚úÖ Country selected: ${session.selectedCountry}</p>`;
                    }
                    
                    if (!session.departments || session.departments.length === 0) {
                        analysis += `<p class="error">‚ùå Issue: No departments assigned - this will prevent seeing any cases!</p>`;
                    } else {
                        analysis += `<p class="success">‚úÖ Departments assigned: ${session.departments.join(', ')}</p>`;
                    }
                    
                    if (!session.countries || !session.countries.includes(session.selectedCountry)) {
                        analysis += `<p class="error">‚ùå Issue: Selected country (${session.selectedCountry}) not in assigned countries</p>`;
                    } else {
                        analysis += `<p class="success">‚úÖ Selected country is in assigned countries</p>`;
                    }
                    
                    // Check cases that should be visible
                    const visibleCases = cases.filter(c => {
                        const countryMatch = c.country === session.selectedCountry;
                        const departmentMatch = session.departments && session.departments.includes(c.department);
                        return countryMatch && departmentMatch;
                    });
                    
                    analysis += `<h3>Cases Analysis:</h3>`;
                    analysis += `<p><strong>Total cases in system:</strong> ${cases.length}</p>`;
                    analysis += `<p><strong>Cases in ${session.selectedCountry}:</strong> ${cases.filter(c => c.country === session.selectedCountry).length}</p>`;
                    analysis += `<p><strong>Cases visible to this user:</strong> ${visibleCases.length}</p>`;
                    
                    if (visibleCases.length === 0) {
                        analysis += `<p class="error">‚ùå No cases are visible to this user!</p>`;
                        analysis += `<p class="warning">Possible reasons:</p>`;
                        analysis += `<ul>`;
                        analysis += `<li>No cases exist for country: ${session.selectedCountry}</li>`;
                        analysis += `<li>No cases exist for departments: ${session.departments ? session.departments.join(', ') : 'None'}</li>`;
                        analysis += `<li>Cases exist but don't match both country AND department</li>`;
                        analysis += `</ul>`;
                        
                        // Show department breakdown
                        const allDepartments = [...new Set(cases.map(c => c.department))];
                        analysis += `<p><strong>Departments in system:</strong> ${allDepartments.join(', ')}</p>`;
                        
                        const countryCases = cases.filter(c => c.country === session.selectedCountry);
                        if (countryCases.length > 0) {
                            const countryDepartments = [...new Set(countryCases.map(c => c.department))];
                            analysis += `<p><strong>Departments in ${session.selectedCountry}:</strong> ${countryDepartments.join(', ')}</p>`;
                        }
                    } else {
                        analysis += `<p class="success">‚úÖ ${visibleCases.length} cases should be visible</p>`;
                    }
                } else {
                    analysis += `<p class="warning">‚ö†Ô∏è User role is not Operations Manager (current: ${session.role})</p>`;
                }
            } else {
                analysis += `<p class="error">‚ùå No active session</p>`;
            }
            
            document.getElementById('analysis').innerHTML = analysis;
        }
        
        function fixOperationsManagerUser() {
            const users = JSON.parse(localStorage.getItem('case-booking-users') || '[]');
            
            // Check if Operations Manager already exists
            let opsManager = users.find(u => u.role === 'operations-manager' || u.role === 'operation-manager');
            
            if (!opsManager) {
                // Create new Operations Manager
                opsManager = {
                    id: Date.now().toString(),
                    username: 'OpsManager',
                    password: 'password123',
                    name: 'Operations Manager',
                    role: 'operations-manager',
                    departments: ['Cardiology', 'Orthopedics', 'Neurosurgery'],
                    countries: ['Singapore'],
                    email: 'opsmanager@example.com',
                    enabled: true
                };
                users.push(opsManager);
            } else {
                // Update existing Operations Manager
                opsManager.departments = ['Cardiology', 'Orthopedics', 'Neurosurgery'];
                opsManager.countries = ['Singapore'];
                opsManager.enabled = true;
            }
            
            localStorage.setItem('case-booking-users', JSON.stringify(users));
            alert('Operations Manager user created/updated with departments: Cardiology, Orthopedics, Neurosurgery');
            loadAndDisplay();
        }
        
        function createTestCases() {
            const cases = JSON.parse(localStorage.getItem('case-booking-cases') || '[]');
            
            // Create test cases for Singapore with various departments
            const testCases = [
                {
                    id: 'test-1',
                    caseReferenceNumber: 'TMC000001',
                    hospital: 'Singapore General Hospital',
                    department: 'Cardiology',
                    dateOfSurgery: '2025-01-15',
                    procedureType: 'Heart',
                    procedureName: 'Cardiac Catheterization',
                    doctorName: 'Dr. Tan Wei Ming',
                    timeOfProcedure: '10:00',
                    surgerySetSelection: ['Cardiac Set A'],
                    implantBox: ['Stent Package'],
                    specialInstruction: 'Test case for Operations Manager',
                    status: 'Case Booked',
                    submittedBy: 'Test User',
                    submittedAt: new Date().toISOString(),
                    country: 'Singapore',
                    statusHistory: []
                },
                {
                    id: 'test-2',
                    caseReferenceNumber: 'TMC000002',
                    hospital: 'Tan Tock Seng Hospital',
                    department: 'Orthopedics',
                    dateOfSurgery: '2025-01-16',
                    procedureType: 'Knee',
                    procedureName: 'Total Knee Replacement',
                    doctorName: 'Dr. Lee Seng Hock',
                    timeOfProcedure: '14:00',
                    surgerySetSelection: ['Orthopedic Set B'],
                    implantBox: ['Knee Implant'],
                    specialInstruction: 'Test case for Operations Manager',
                    status: 'Order Preparation',
                    submittedBy: 'Test User',
                    submittedAt: new Date().toISOString(),
                    country: 'Singapore',
                    statusHistory: []
                },
                {
                    id: 'test-3',
                    caseReferenceNumber: 'TMC000003',
                    hospital: 'National Neuroscience Institute',
                    department: 'Neurosurgery',
                    dateOfSurgery: '2025-01-17',
                    procedureType: 'Head',
                    procedureName: 'Brain Tumor Removal',
                    doctorName: 'Dr. Lim Hwee Choo',
                    timeOfProcedure: '09:00',
                    surgerySetSelection: ['Neuro Set C'],
                    implantBox: ['Cranial Plate'],
                    specialInstruction: 'Test case for Operations Manager',
                    status: 'Order Prepared',
                    submittedBy: 'Test User',
                    submittedAt: new Date().toISOString(),
                    country: 'Singapore',
                    statusHistory: []
                }
            ];
            
            // Add test cases if they don't exist
            testCases.forEach(testCase => {
                if (!cases.find(c => c.id === testCase.id)) {
                    cases.unshift(testCase);
                }
            });
            
            localStorage.setItem('case-booking-cases', JSON.stringify(cases));
            alert('Test cases created for Singapore (Cardiology, Orthopedics, Neurosurgery)');
            loadAndDisplay();
        }
        
        function clearLocalStorage() {
            if (confirm('This will clear ALL data including users and cases. Are you sure?')) {
                localStorage.clear();
                alert('All data cleared. Refresh the main application to see default data.');
                loadAndDisplay();
            }
        }
        
        // Load data on page load
        loadAndDisplay();
        
        // Refresh every 5 seconds
        setInterval(loadAndDisplay, 5000);
    </script>
</body>
</html>