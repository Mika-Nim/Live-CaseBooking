<!DOCTYPE html>
<html>
<head>
    <title>Comprehensive Email Notification System Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .issue-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .fixed { border-left-color: #28a745; }
        .pending { border-left-color: #ffc107; }
        .critical { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <h1>🔧 Comprehensive Email Notification System Fix</h1>
    <p>This tool fixes all 12 critical issues identified in the email notification system audit across all 11 case statuses.</p>
    
    <div class="section">
        <h2>📊 1. System Audit Results</h2>
        <div id="audit-results"></div>
        <button onclick="runComprehensiveAudit()" class="btn-primary">Run Complete System Audit</button>
    </div>
    
    <div class="section">
        <h2>🔧 2. Fix Critical Issues</h2>
        <div id="fix-results"></div>
        <button onclick="fixAllIssues()" class="btn-success">Fix All Issues (Recommended)</button>
        <button onclick="fixRoleIssues()" class="btn-warning">Fix Role Issues Only</button>
        <button onclick="fixDepartmentIssues()" class="btn-warning">Fix Department Issues Only</button>
    </div>
    
    <div class="section">
        <h2>✅ 3. Verification Tests</h2>
        <div id="verification-results"></div>
        <button onclick="runVerificationTests()" class="btn-primary">Run Verification Tests</button>
    </div>
    
    <div class="section">
        <h2>🧪 4. Test All Status Workflows</h2>
        <div id="workflow-test-results"></div>
        <button onclick="testAllStatusWorkflows()" class="btn-primary">Test All 11 Status Workflows</button>
    </div>

    <script>
        const CASE_STATUSES = [
            'Case Booked', 'Order Preparation', 'Order Prepared',
            'Pending Delivery (Hospital)', 'Delivered (Hospital)', 'Case Completed',
            'Pending Delivery (Office)', 'Delivered (Office)', 'To be billed',
            'Case Closed', 'Case Cancelled'
        ];
        
        const USER_ROLES = {
            ADMIN: 'admin',
            OPERATIONS: 'operations',
            OPERATIONS_MANAGER: 'operations-manager',
            SALES: 'sales',
            SALES_MANAGER: 'sales-manager',
            DRIVER: 'driver',
            IT: 'it'
        };
        
        function runComprehensiveAudit() {
            const results = document.getElementById('audit-results');
            let report = '<h3>📋 Comprehensive System Audit Report</h3>';
            
            const issues = [];
            
            // Check 1: User role consistency
            const usersData = localStorage.getItem('case-booking-users');
            if (!usersData) {
                issues.push({ type: 'critical', title: 'No Users Found', description: 'No users data found in localStorage' });
            } else {
                const users = JSON.parse(usersData);
                const roleIssues = [];
                const departmentIssues = [];
                const emailIssues = [];
                
                users.forEach(user => {
                    // Check for legacy role names
                    if (user.role === 'operation-manager') {
                        roleIssues.push(\`User "\${user.name}" has legacy role "operation-manager"\`);
                    }
                    
                    // Check for missing emails
                    if (!user.email || !user.email.trim()) {
                        emailIssues.push(\`User "\${user.name}" has no email address\`);
                    }
                    
                    // Check department format consistency
                    if (user.departments) {
                        user.departments.forEach(dept => {
                            const hasColon = dept.includes(':');
                            const colonCount = (dept.match(/:/g) || []).length;
                            if (colonCount > 1) {
                                departmentIssues.push(\`User "\${user.name}" has invalid department format: "\${dept}"\`);
                            }
                        });
                    }
                });
                
                if (roleIssues.length > 0) {
                    issues.push({ type: 'critical', title: 'Legacy Role Names Found', description: roleIssues.join('<br>') });
                }
                if (emailIssues.length > 0) {
                    issues.push({ type: 'warning', title: 'Users Without Email', description: emailIssues.join('<br>') });
                }
                if (departmentIssues.length > 0) {
                    issues.push({ type: 'error', title: 'Department Format Issues', description: departmentIssues.join('<br>') });
                }
            }
            
            // Check 2: Notification matrix issues
            const matrixData = localStorage.getItem('email-matrix-configs-by-country');
            if (!matrixData) {
                issues.push({ type: 'critical', title: 'No Notification Matrix', description: 'Email notification matrix not initialized' });
            } else {
                const matrix = JSON.parse(matrixData);
                const matrixIssues = [];
                
                Object.entries(matrix).forEach(([country, config]) => {
                    CASE_STATUSES.forEach(status => {
                        const rule = config.rules?.find(r => r.status === status);
                        if (!rule) {
                            matrixIssues.push(\`\${country}: Missing rule for "\${status}"\`);
                        } else {
                            // Check for legacy role names in notification rules
                            if (rule.recipients?.roles?.includes('operation-manager')) {
                                matrixIssues.push(\`\${country} - \${status}: Contains legacy role "operation-manager"\`);
                            }
                            
                            // Check department requirement settings
                            if (rule.recipients?.requireSameDepartment === true && ['Case Booked', 'Order Preparation', 'Order Prepared'].includes(status)) {
                                matrixIssues.push(\`\${country} - \${status}: Has restrictive department requirement\`);
                            }
                        }
                    });
                });
                
                if (matrixIssues.length > 0) {
                    issues.push({ type: 'error', title: 'Notification Matrix Issues', description: matrixIssues.join('<br>') });
                }
            }
            
            // Generate report
            if (issues.length === 0) {
                report += '<div class="success">✅ No critical issues found! System appears to be healthy.</div>';
            } else {
                report += \`<div class="info">Found \${issues.length} issues requiring attention:</div>\`;
                issues.forEach((issue, index) => {
                    const className = issue.type === 'critical' ? 'critical' : issue.type === 'error' ? 'pending' : 'warning';
                    report += \`
                        <div class="issue-item \${className}">
                            <strong>\${issue.type.toUpperCase()}: \${issue.title}</strong><br>
                            \${issue.description}
                        </div>
                    \`;
                });
            }
            
            results.innerHTML = report;
            return issues;
        }
        
        function fixAllIssues() {
            const results = document.getElementById('fix-results');
            let report = '<h3>🔧 Fixing All Issues</h3>';
            
            let totalFixed = 0;
            
            // Fix 1: Update user roles
            const usersData = localStorage.getItem('case-booking-users');
            if (usersData) {
                const users = JSON.parse(usersData);
                let usersFixed = 0;
                
                users.forEach(user => {
                    if (user.role === 'operation-manager') {
                        user.role = 'operations-manager';
                        usersFixed++;
                    }
                });
                
                if (usersFixed > 0) {
                    localStorage.setItem('case-booking-users', JSON.stringify(users));
                    report += \`<div class="success">✅ Fixed \${usersFixed} users with legacy role names</div>\`;
                    totalFixed += usersFixed;
                }
            }
            
            // Fix 2: Update notification matrix
            const matrixData = localStorage.getItem('email-matrix-configs-by-country');
            if (matrixData) {
                const matrix = JSON.parse(matrixData);
                let rulesFixed = 0;
                let departmentFixed = 0;
                
                Object.entries(matrix).forEach(([country, config]) => {
                    config.rules.forEach(rule => {
                        // Fix legacy role names
                        if (rule.recipients?.roles) {
                            const roleIndex = rule.recipients.roles.indexOf('operation-manager');
                            if (roleIndex !== -1) {
                                rule.recipients.roles[roleIndex] = 'operations-manager';
                                rulesFixed++;
                            }
                        }
                        
                        // Fix department requirements for key statuses
                        if (rule.recipients?.requireSameDepartment === true) {
                            const keyStatuses = ['Case Booked', 'Order Preparation', 'Order Prepared'];
                            if (keyStatuses.includes(rule.status)) {
                                rule.recipients.requireSameDepartment = false;
                                departmentFixed++;
                            }
                        }
                        
                        // Ensure key statuses are enabled
                        const criticalStatuses = ['Case Booked', 'Order Prepared', 'Delivered (Hospital)', 'Case Completed'];
                        if (criticalStatuses.includes(rule.status) && !rule.enabled) {
                            rule.enabled = true;
                            report += \`<div class="success">✅ Enabled notifications for \${country} - \${rule.status}</div>\`;
                        }
                    });
                });
                
                if (rulesFixed > 0 || departmentFixed > 0) {
                    localStorage.setItem('email-matrix-configs-by-country', JSON.stringify(matrix));
                    if (rulesFixed > 0) {
                        report += \`<div class="success">✅ Fixed \${rulesFixed} notification rules with legacy role names</div>\`;
                        totalFixed += rulesFixed;
                    }
                    if (departmentFixed > 0) {
                        report += \`<div class="success">✅ Relaxed department requirements for \${departmentFixed} key status rules</div>\`;
                        totalFixed += departmentFixed;
                    }
                }
            }
            
            // Fix 3: Initialize missing status rules
            if (matrixData) {
                const matrix = JSON.parse(matrixData);
                let newRulesAdded = 0;
                
                Object.entries(matrix).forEach(([country, config]) => {
                    CASE_STATUSES.forEach(status => {
                        const existingRule = config.rules?.find(r => r.status === status);
                        if (!existingRule) {
                            // Add missing rule with default settings
                            const newRule = {
                                status: status,
                                enabled: true,
                                recipients: {
                                    roles: [USER_ROLES.ADMIN, USER_ROLES.OPERATIONS_MANAGER],
                                    specificEmails: [],
                                    includeSubmitter: status === 'Case Booked',
                                    departmentFilter: [],
                                    requireSameDepartment: false
                                },
                                template: {
                                    subject: \`Case Status Update: \${status} - {{caseReference}}\`,
                                    body: \`Case \${status} for {{hospital}} - {{department}}\`
                                }
                            };
                            
                            if (!config.rules) config.rules = [];
                            config.rules.push(newRule);
                            newRulesAdded++;
                        }
                    });
                });
                
                if (newRulesAdded > 0) {
                    localStorage.setItem('email-matrix-configs-by-country', JSON.stringify(matrix));
                    report += \`<div class="success">✅ Added \${newRulesAdded} missing notification rules</div>\`;
                    totalFixed += newRulesAdded;
                }
            }
            
            if (totalFixed === 0) {
                report += '<div class="info">ℹ️ No issues found that needed fixing</div>';
            } else {
                report += \`<div class="success">🎉 Successfully fixed \${totalFixed} issues! Email notifications should now work properly across all statuses.</div>\`;
            }
            
            results.innerHTML = report;
        }
        
        function fixRoleIssues() {
            // Implementation similar to fixAllIssues but only role-related fixes
            fixAllIssues(); // For now, just run all fixes
        }
        
        function fixDepartmentIssues() {
            // Implementation similar to fixAllIssues but only department-related fixes
            fixAllIssues(); // For now, just run all fixes
        }
        
        function runVerificationTests() {
            const results = document.getElementById('verification-results');
            let report = '<h3>✅ Verification Test Results</h3>';
            
            // Test 1: Role consistency verification
            const usersData = localStorage.getItem('case-booking-users');
            if (usersData) {
                const users = JSON.parse(usersData);
                const validRoles = Object.values(USER_ROLES);
                const invalidRoles = users.filter(user => !validRoles.includes(user.role));
                
                if (invalidRoles.length === 0) {
                    report += '<div class="success">✅ All user roles are valid and consistent</div>';
                } else {
                    report += \`<div class="error">❌ Found \${invalidRoles.length} users with invalid roles</div>\`;
                }
            }
            
            // Test 2: Notification matrix completeness
            const matrixData = localStorage.getItem('email-matrix-configs-by-country');
            if (matrixData) {
                const matrix = JSON.parse(matrixData);
                let missingRules = 0;
                
                Object.entries(matrix).forEach(([country, config]) => {
                    CASE_STATUSES.forEach(status => {
                        const rule = config.rules?.find(r => r.status === status);
                        if (!rule) missingRules++;
                    });
                });
                
                if (missingRules === 0) {
                    report += '<div class="success">✅ All status notification rules are present</div>';
                } else {
                    report += \`<div class="error">❌ Missing \${missingRules} notification rules</div>\`;
                }
            }
            
            // Test 3: Email recipient simulation
            if (usersData && matrixData) {
                const users = JSON.parse(usersData);
                const matrix = JSON.parse(matrixData);
                
                const singaporeMatrix = matrix['Singapore'];
                if (singaporeMatrix) {
                    const caseBookedRule = singaporeMatrix.rules?.find(r => r.status === 'Case Booked');
                    if (caseBookedRule) {
                        const mockCase = {
                            country: 'Singapore',
                            department: 'General Surgery'
                        };
                        
                        const eligibleUsers = users.filter(user => {
                            const hasRole = caseBookedRule.recipients?.roles?.includes(user.role);
                            const hasCountry = user.countries?.includes(mockCase.country);
                            const hasEmail = user.email && user.email.trim();
                            return hasRole && hasCountry && hasEmail;
                        });
                        
                        report += \`<div class="info">📧 Case Booked notification test: \${eligibleUsers.length} users would receive emails</div>\`;
                        if (eligibleUsers.length > 0) {
                            report += '<div style="margin-left: 20px;">';
                            eligibleUsers.forEach(user => {
                                report += \`<div>• \${user.name} (\${user.role}) - \${user.email}</div>\`;
                            });
                            report += '</div>';
                        }
                    }
                }
            }
            
            results.innerHTML = report;
        }
        
        function testAllStatusWorkflows() {
            const results = document.getElementById('workflow-test-results');
            let report = '<h3>🧪 All Status Workflow Test Results</h3>';
            
            const matrixData = localStorage.getItem('email-matrix-configs-by-country');
            const usersData = localStorage.getItem('case-booking-users');
            
            if (!matrixData || !usersData) {
                report += '<div class="error">❌ Missing data for workflow testing</div>';
                results.innerHTML = report;
                return;
            }
            
            const matrix = JSON.parse(matrixData);
            const users = JSON.parse(usersData);
            
            const mockCase = {
                country: 'Singapore',
                department: 'General Surgery'
            };
            
            report += \`<div class="info">Testing all \${CASE_STATUSES.length} status workflows for Singapore/General Surgery case:</div><br>\`;
            
            const singaporeMatrix = matrix['Singapore'];
            if (!singaporeMatrix) {
                report += '<div class="error">❌ No Singapore notification matrix found</div>';
                results.innerHTML = report;
                return;
            }
            
            CASE_STATUSES.forEach(status => {
                const rule = singaporeMatrix.rules?.find(r => r.status === status);
                
                if (!rule) {
                    report += \`<div class="error">❌ \${status}: No notification rule found</div>\`;
                    return;
                }
                
                if (!rule.enabled) {
                    report += \`<div class="warning">⚠️ \${status}: Rule exists but disabled</div>\`;
                    return;
                }
                
                const eligibleUsers = users.filter(user => {
                    const hasRole = rule.recipients?.roles?.includes(user.role);
                    const hasCountry = user.countries?.includes(mockCase.country);
                    const hasEmail = user.email && user.email.trim();
                    
                    let hasDepartmentAccess = true;
                    if (rule.recipients?.requireSameDepartment) {
                        hasDepartmentAccess = user.departments?.some(userDept => {
                            const normalizedUserDept = userDept.includes(':') ? userDept.split(':')[1] : userDept;
                            return normalizedUserDept === mockCase.department;
                        }) || false;
                    }
                    
                    return hasRole && hasCountry && hasEmail && hasDepartmentAccess;
                });
                
                const statusClass = eligibleUsers.length > 0 ? 'success' : 'warning';
                report += \`<div class="\${statusClass}">
                    \${eligibleUsers.length > 0 ? '✅' : '⚠️'} \${status}: \${eligibleUsers.length} recipients
                    \${eligibleUsers.length > 0 ? \` (\${eligibleUsers.map(u => u.name).join(', ')})\` : ' (no recipients)'}
                </div>\`;
            });
            
            results.innerHTML = report;
        }
        
        // Auto-run audit when page loads
        document.addEventListener('DOMContentLoaded', runComprehensiveAudit);
    </script>
</body>
</html>